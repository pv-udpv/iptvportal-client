# IPTVPortal Client - Workspace Rules

## Project Management
- **Package Manager**: This project uses `uv` as the Python package manager
- **Virtual Environment**: `uv` automatically manages virtual environments
- **Dependencies**: All dependencies are managed through `uv.lock`
- **Python Version**: Managed by `uv` (see `pyproject.toml`)

## Command Execution
All commands must use `uv run` prefix for proper environment isolation:

```bash
# Running tests
uv run pytest

# Running specific test files
uv run pytest tests/test_sync_config.py

# Running with coverage
uv run pytest --cov=src/iptvportal/sync --cov-report=html

# Running the CLI
uv run python -m iptvportal.cli --help

# Running sync commands
uv run python -m iptvportal.cli sync --help

# Adding dependencies
uv add pytest-asyncio pytest-mock

# Installing in development mode
uv sync

# Running linters/formatters
uv run ruff check .
uv run ruff format .
```

## Development Workflow
1. **Setup**: `uv sync` to install dependencies
2. **Testing**: `uv run pytest` to run all tests
3. **Linting**: `uv run ruff check .` and `uv run ruff format .`
4. **CLI Testing**: `uv run python -m iptvportal.cli [command]`
5. **Adding Packages**: `uv add [package]` for new dependencies

## Testing Guidelines
- All tests must be runnable with `uv run pytest`
- Use `pytest-asyncio` for async tests
- Mock external dependencies (API calls, database connections)
- Test files should be in `tests/` directory
- Use descriptive test names and docstrings
- Aim for >90% coverage on new code

## Code Quality
- Use `uv run ruff` for linting and formatting
- Follow existing code patterns and naming conventions
- Add type hints for new functions
- Write comprehensive docstrings
- Use async/await for I/O operations

## File Structure
- Source code in `src/iptvportal/`
- Tests in `tests/`
- Configuration in `config/`
- Documentation in `docs/`
- Use `uv run` for all executable commands

## Git Workflow
- **Automated Workflow**: Use `./scripts/git-workflow.sh` for complete commit → test → push → PR workflow
- **Conventional Commits**: All commits must follow `type(scope): description` format
- **Git Hooks**: Automatic quality checks via `.githooks/` (setup with `./scripts/setup-hooks.sh`)
- **Branch Naming**: Use `issue-123-feature-name` for issue-related branches
- **PR Creation**: Use `./scripts/create-pr.sh` with automatic issue linking
- **Quality Gates**: Pre-commit hooks enforce linting, formatting, and testing

### Workflow Scripts
```bash
# One-time setup
chmod +x scripts/*.sh
./scripts/setup-hooks.sh

# Daily workflow
./scripts/git-workflow.sh                    # Full automated workflow
./scripts/commit-helper.sh                   # Interactive commit builder
./scripts/create-pr.sh --issue 123           # Create PR with issue link
./scripts/issue-branch.sh 456                # Create branch from issue
./scripts/validate-commit.sh --all           # Validate commit messages
```

### Conventional Commit Format
```
type(scope): description

# Types: feat, fix, docs, test, refactor, chore, perf, style, ci, revert, build
# Scopes: sync, cli, transpiler, schema, cache, config, docs, test, ci, deps
# Examples:
feat(sync): Add incremental sync strategy
fix(cli): Handle invalid command arguments
test(schema): Add validation tests
```

### Git Hooks (Automatic)
- **pre-commit**: Linting, formatting, quick tests, debug statement detection
- **commit-msg**: Message format validation, issue reference suggestions
- **post-commit**: Helpful suggestions, PR creation offers, status updates
- **pre-push**: Full test suite, coverage check, main branch protection

**Skip hooks**: Use `--no-verify` flag (e.g., `git commit --no-verify`)

## Cline Workflow Integration

Cline AI assistant integrates with the git workflow to provide continuous checklist tracking, automatic progress updates, and seamless GitHub integration.

### Cline Checklist Tracking

**Always use `task_progress` parameter** in Cline responses to track task progress. This enables automatic synchronization with git workflow.

**Checklist Format:**
```markdown
- [x] Completed task with commit reference
- [ ] In progress task
- [ ] Pending task
```

**Auto-save to `.cline-progress`**: Cline automatically maintains task progress in JSON format for integration with git workflow scripts.

### Cline Workflow Scripts

```bash
# Initialize Cline tracking for an issue
./scripts/cline-init.sh --issue 123

# Make commits with checklist references
./scripts/cline-commit.sh --items "1,3" --type feat --scope sync

# Create PR with full checklist integration
./scripts/cline-pr.sh --sync-issue

# Sync progress to GitHub issue comments
./scripts/cline-sync.sh --to-issue

# View current progress dashboard
./scripts/cline-status.sh
```

### Cline Commit Guidelines

**Always reference checklist items** in commit messages:
```
feat(sync): Add incremental sync strategy

Completes: #1, #3 (from .cline-progress)
Related: issue-123

- [x] Setup database schema
- [x] Add incremental logic
- [ ] Add tests (next commit)
```

**Link checklist items to commits**: Each completed checklist item should reference the commit SHA that implements it.

### Cline PR Integration

**PR descriptions include full checklists** with:
- Completed items linked to commits
- In-progress items clearly marked
- Completion percentage
- Issue and branch references

**Automatic issue linking**: PRs automatically link to GitHub issues via branch names (`issue-123-feature`) or explicit `--issue` flags.

### Cline GitHub Integration

**Real-time progress updates**: Post checklist progress to GitHub issue comments automatically or on-demand.

**GitHub API/MCP fallback**: Uses `gh` CLI when available, falls back to GitHub API or MCP servers for integration.

### Cline Task Progress Rules

1. **Always use `task_progress`** parameter in tool calls
2. **Format checklists consistently** with `- [x]` for completed, `- [ ]` for pending
3. **Reference issue numbers** in all operations when working on issue-related tasks
4. **Link checklist items to commits** when marking items complete
5. **Update progress regularly** to maintain accurate tracking
6. **Use descriptive task names** that clearly indicate what was accomplished

### Cline Quality Gates

**Pre-commit validation**: Git hooks validate checklist consistency and warn about incomplete critical items.

**Commit message validation**: Ensures checklist references are properly formatted and linked.

**PR creation validation**: Verifies all checklist items have appropriate commit references.

### Cline Progress Persistence

**`.cline-progress` file**: JSON format tracking all checklist items with metadata:
- Issue and branch references
- Completion status and timestamps
- Commit SHA links
- Priority levels and dependencies

**Git-tracked**: Progress file is committed to git for full audit trail.

### Cline Advanced Features

**Priority levels**: Mark critical items that must complete before PR creation.

**Dependency tracking**: Define task dependencies to prevent working on blocked items.

**Time tracking**: Automatic duration calculation for productivity metrics.

**Multi-issue support**: Work on multiple issues simultaneously with separate progress tracking.

## Makefile Commands
- **Build System**: Comprehensive Makefile with uv integration for all development tasks
- **Help**: Run `make` or `make help` to see all available commands with descriptions

### Installation & Setup:
```bash
make install      # Production dependencies only
make install-dev  # All dependencies including dev
make sync         # Sync production dependencies
make sync-dev     # Sync all dependencies
make dev          # Set up development environment
```

### Testing:
```bash
make test                    # Run all tests
make test-cov               # Tests with coverage report
make test-verbose           # Verbose test output
make test-specific TEST=file.py  # Run specific test file
make test-watch             # Tests in watch mode
```

### Code Quality:
```bash
make lint         # Run ruff linter
make lint-fix     # Linter with auto-fix
make format       # Format code with ruff
make format-check # Check formatting without changes
make type-check   # Run mypy type checker
make check        # Run all checks (lint, format, type)
make check-fix    # Run checks with auto-fix
```

### CLI Shortcuts:
```bash
make cli ARGS="command args"  # Run CLI with arguments
make cli-help                 # Show CLI help
make cli-auth                 # Authenticate
make cli-sync-init           # Initialize sync
make cli-sync-pull           # Pull data
make cli-sync-status         # Show sync status
```

### Development Workflows:
```bash
make quick        # Fast feedback (lint-fix + tests)
make pre-commit   # Full pre-commit checks
make ci           # CI-style checks (no auto-fix)
```

### Utilities:
```bash
make clean        # Remove cache/build artifacts
make build        # Build distribution packages
make shell        # Start IPython shell
make cache-clear  # Clear all caches
make info         # Show project information
make version      # Show project version
```

### Workflow Integration:
- Makefile commands integrate with git hooks and workflow scripts
- All commands use `uv run` for proper environment isolation
- Color-coded output for better readability
- Comprehensive help system with target descriptions

## Important Notes
- Never use `pip` directly - always use `uv add` or `uv sync`
- Never use `python` directly - always use `uv run python`
- All scripts and tools should work with `uv run`
- Virtual environment is managed automatically by `uv`
- Use `make` commands for all development operations
