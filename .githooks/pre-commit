#!/bin/bash
# IPTVPortal pre-commit hook
# Runs quality checks before allowing commits

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# Check if uv is available
check_uv() {
    if ! command -v uv &> /dev/null; then
        log_error "uv is not available. Please install uv or run outside git hooks."
        exit 1
    fi
}

# Run linter
run_linter() {
    log_info "Running linter (ruff check)..."
    if uv run ruff check .; then
        log_success "Linting passed"
    else
        log_error "Linting failed. Fix the issues or use --no-verify to skip hooks."
        exit 1
    fi
}

# Run formatter check
run_formatter() {
    log_info "Checking code formatting..."
    if uv run ruff format --check .; then
        log_success "Code formatting is correct"
    else
        log_error "Code formatting issues found. Run 'uv run ruff format .' to fix."
        exit 1
    fi
}

# Run quick tests
run_quick_tests() {
    log_info "Running quick tests..."
    # Run a subset of tests to catch obvious issues
    if uv run pytest tests/ -x --tb=short --disable-warnings -q; then
        log_success "Quick tests passed"
    else
        log_error "Tests failed. Fix the issues or use --no-verify to skip hooks."
        exit 1
    fi
}

# Check for debug statements
check_debug_statements() {
    log_info "Checking for debug statements..."

    # Files to check
    local files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(py)$' || true)

    if [ -z "$files" ]; then
        log_info "No Python files to check"
        return
    fi

    local found_debug=false

    for file in $files; do
        if [ -f "$file" ]; then
            # Check for common debug statements
            if grep -n -E "(print\(|debugger|import pdb|console\.log)" "$file" > /dev/null 2>&1; then
                log_warning "Found potential debug statements in $file:"
                grep -n -E "(print\(|debugger|import pdb|console\.log)" "$file"
                found_debug=true
            fi
        fi
    done

    if $found_debug; then
        echo ""
        log_warning "Debug statements found. Remove them or use --no-verify to skip this check."
        echo "Common debug statements to remove:"
        echo "  - print() statements"
        echo "  - import pdb; pdb.set_trace()"
        echo "  - debugger"
        echo "  - console.log() (in JS files)"
        exit 1
    else
        log_success "No debug statements found"
    fi
}

# Check for large files
check_large_files() {
    log_info "Checking for large files..."

    local max_size=$((10 * 1024 * 1024))  # 10MB

    # Check staged files
    local large_files=$(git diff --cached --name-only | xargs -I {} sh -c 'if [ -f "{}" ] && [ $(stat -f%z "{}" 2>/dev/null || stat -c%s "{}" 2>/dev/null || echo 0) -gt '$max_size' ]; then echo "{}"; fi' 2>/dev/null || true)

    if [ -n "$large_files" ]; then
        log_error "Large files detected (>10MB):"
        echo "$large_files"
        log_error "Consider using Git LFS for large files or remove them from staging."
        exit 1
    else
        log_success "No large files found"
    fi
}

# Check for TODO/FIXME comments in new code
check_todos() {
    log_info "Checking for TODO/FIXME comments in new code..."

    # Get changed lines
    local todos=$(git diff --cached -U0 | grep -E "^\+.*(TODO|FIXME|XXX|HACK)" | sed 's/^+//' | head -5 || true)

    if [ -n "$todos" ]; then
        log_warning "Found TODO/FIXME comments in new code:"
        echo "$todos" | sed 's/^/  /'
        echo ""
        log_info "Consider addressing these before committing, or use --no-verify to skip."
        # Don't fail on TODOs, just warn
    else
        log_success "No TODO/FIXME comments found in new code"
    fi
}

# Check Cline checklist consistency
check_cline_checklist() {
    if [ ! -f ".cline-progress" ]; then
        # No checklist file, skip this check
        return 0
    fi

    log_info "Checking Cline checklist consistency..."

    # Source the helper functions
    if [ -f "scripts/cline-helpers.sh" ]; then
        source "scripts/cline-helpers.sh"

        # Validate checklist
        if validate_checklist; then
            log_success "Cline checklist is consistent"
        else
            log_warning "Cline checklist validation failed"
            log_info "Some completed items may be missing commit references"
            log_info "This will be fixed automatically after commit"
            # Don't fail on this, just warn
        fi
    else
        log_warning "Cline helpers not found, skipping checklist validation"
    fi
}

# Main function
main() {
    log_info "Running IPTVPortal pre-commit checks..."

    check_uv
    run_linter
    run_formatter
    run_quick_tests
    check_debug_statements
    check_large_files
    check_todos
    check_cline_checklist

    log_success "All pre-commit checks passed! ðŸŽ‰"
}

# Run main function
main "$@"
